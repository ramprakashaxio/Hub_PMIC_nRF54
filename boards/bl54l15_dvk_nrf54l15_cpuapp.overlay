/*
 * BL54L15 DVK overlay for MAX77658 PMIC and MAX32664C Sensor Hub
 *
 * Hardware Wiring:
 *   SDA: P1.11
 *   SCL: P1.12
 *
 * MAX32664C Sensor Hub Pins:
 *   HUB_MFIO: P1.13
 *   HUB_RST:  P0.04
 *   OE:       P1.14
 *
 * PMIC GPIO Pins:
 *   PMIC_NEN:  P1.07
 *   PMIC_nIRQ: P1.06
 *   PMIC_nRST: P1.05
 *
 * UART Pins:
 *   TX: P1.08
 *   RX: P1.09
 */
&pinctrl {
    /* I2C21 pins */
    i2c21_default: i2c21_default {
        group1 {
            /* YOUR CUSTOM WIRING */
            psels = <NRF_PSEL(TWIM_SDA, 1, 11)>,  /* SDA = P1.11 */
                    <NRF_PSEL(TWIM_SCL, 1, 12)>;  /* SCL = P1.12 */
            bias-pull-up;
        };
    };

    i2c21_sleep: i2c21_sleep {
        group1 {
            psels = <NRF_PSEL(TWIM_SDA, 1, 11)>,
                    <NRF_PSEL(TWIM_SCL, 1, 12)>;
            low-power-enable;
        };
    };

    /* UART configured for external FTDI on P1.08/09 */
    uart20_default: uart20_default {
        group1 {
            psels = <NRF_PSEL(UART_TX, 1, 8)>;   /* P1.08 = TX */
        };
        group2 {
            psels = <NRF_PSEL(UART_RX, 1, 9)>;   /* P1.09 = RX */
            bias-pull-up;
        };
    };

    uart20_sleep: uart20_sleep {
        group1 {
            psels = <NRF_PSEL(UART_TX, 1, 8)>,   /* P1.08 = TX */
                    <NRF_PSEL(UART_RX, 1, 9)>;   /* P1.09 = RX */
            low-power-enable;
        };
    };
};

/* Configure I2C21 with custom pins (nRF54L15 uses i2c21) */
&i2c21 {
    status = "okay";
    pinctrl-0 = <&i2c21_default>;
    pinctrl-1 = <&i2c21_sleep>;
    pinctrl-names = "default", "sleep";
    clock-frequency = <I2C_BITRATE_STANDARD>;  /* 100kHz, can use I2C_BITRATE_FAST for 400kHz */

    /* MAX32664C Biometric Sensor Hub */
    max32664c: max32664c@55 {
        compatible = "maxim,max32664c";
        reg = <0x55>;
        
        /* GPIO Control */
        reset-gpios = <&gpio0 4 GPIO_ACTIVE_LOW>;
        mfio-gpios  = <&gpio1 13 (GPIO_ACTIVE_LOW | GPIO_OPEN_DRAIN | GPIO_PULL_UP)>;
        
        /* Configuration */
        spo2-calib = <1748 6062 10754>;
        hr-config = <4 1>;
        spo2-config = <4 1>;
        use-max86174;
        motion-time = <5000>;
        motion-threshold = <100>;
        min-integration-time = "58_7us";
        min-sampling-rate = "25sps_avg1";
        max-integration-time = "117_3us";
        max-sampling-rate = "400sps_avg16";
        report-period = <40>;
        led-current = <50 50 50 50>;
    };

    /* MAX77658 PMIC Node (Required for driver communication) */
    max77658: max77658@48 {
        compatible = "maxim,max77658"; 
        reg = <0x48>; 
        irq-gpios = <&gpio1 6 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
    };
};

/* Configure UART20 for debug console (115200 baud) */
&uart20 {
    status = "okay";
    current-speed = <115200>;
    pinctrl-0 = <&uart20_default>;
    pinctrl-1 = <&uart20_sleep>;
    pinctrl-names = "default", "sleep";
};

&nfct {
    status = "disabled";
};

/* GPIO definitions for Manual Control / Aliases */
/ {
    chosen {
        zephyr,code-partition = &slot0_partition;
    };

    /* PMIC GPIO definitions */
    pmic_gpios {
        compatible = "gpio-keys";
        
        pmic_nirq: pmic_nirq {
            gpios = <&gpio1 6 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
            label = "PMIC Interrupt";
        };
        
        pmic_amux: pmic_amux {
            gpios = <&gpio1 4 GPIO_ACTIVE_HIGH>;
            label = "PMIC Analog Mux Output";
        };
    };
    
    pmic_ctrl {
        compatible = "gpio-leds";
        
        pmic_nen: pmic_nen {
            gpios = <&gpio1 7 GPIO_ACTIVE_HIGH>;
            label = "PMIC Enable";
        };
        
        pmic_nrst: pmic_nrst {
            gpios = <&gpio1 5 GPIO_ACTIVE_LOW>;
            label = "PMIC Reset";
        };
        
        hub_oe: hub_oe {
            gpios = <&gpio1 14 GPIO_ACTIVE_HIGH>;
            label = "MAX32664C Output Enable";
        };
    };
    
    aliases {
        /* PMIC aliases */
        pmic-nen = &pmic_nen;
        pmic-irq = &pmic_nirq;
        pmic-rst = &pmic_nrst;
        pmic-amux = &pmic_amux;
        
        /* MAX32664C aliases */
        hub-oe = &hub_oe;
    };
};

/* Flash Partitions for Data Storage (nRF54L15 RRAM) */
&cpuapp_rram {
    /* CRITICAL: Delete the default board partitions to avoid conflicts */
    /delete-node/ partitions;

    partitions {
        compatible = "fixed-partitions";
        #address-cells = <1>;
        #size-cells = <1>;

        /* Bootloader partition (64KB) */
        boot_partition: partition@0 {
            label = "mcuboot";
            reg = <0x00000000 0x00010000>;
        };

        /* Application slot 0 (448KB) */
        slot0_partition: partition@10000 {
            label = "image-0";
            reg = <0x00010000 0x00070000>;
        };

        /* Application slot 1 (448KB) */
        slot1_partition: partition@80000 {
            label = "image-1";
            reg = <0x00080000 0x00070000>;
        };

        /* Storage partition for persistent data (32KB) */
        storage_partition: partition@F0000 {
            label = "storage";
            reg = <0x000F0000 0x00008000>;
        };

        /* Scratch partition for MCUboot swap (32KB) */
        scratch_partition: partition@F8000 {
            label = "image-scratch";
            reg = <0x000F8000 0x00008000>;
        };
    };
};
